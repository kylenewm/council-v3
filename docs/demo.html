<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Council v3 Demo</title>
  <style>
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12141a;
      --bg-inner: #1a1d24;
      --purple: #8b5cf6;
      --blue: #3b82f6;
      --green: #10b981;
      --amber: #f59e0b;
      --red: #ef4444;
      --cyan: #06b6d4;
      --text: #e2e8f0;
      --text-muted: #64748b;
      --text-dim: #475569;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-dark);
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: var(--text);
      padding: 30px;
      min-height: 100vh;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: linear-gradient(90deg, var(--purple), var(--blue), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .flow-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .flow-bar span {
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--bg-card);
      border: 1px solid #2a2d35;
      transition: all 0.5s ease;
    }

    .flow-bar span.active {
      border-color: var(--purple);
      background: rgba(139, 92, 246, 0.1);
      color: var(--purple);
    }

    .flow-bar .arrow {
      background: none;
      border: none;
      color: var(--text-dim);
      padding: 0;
    }

    /* Main layout */
    .main-container {
      display: grid;
      grid-template-columns: 200px 1fr 220px;
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #2a2d35;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      opacity: 0;
      transition: opacity 0.6s ease-out;
      will-change: opacity;
    }

    .card.active::before {
      opacity: 1;
    }

    .card.cyan::before { background: var(--cyan); }
    .card.purple::before { background: var(--purple); }
    .card.blue::before { background: var(--blue); }
    .card.amber::before { background: var(--amber); }
    .card.green::before { background: var(--green); }

    .card-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-dim);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Input column */
    .input-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .voice-card .content {
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .voice-wave {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      margin-bottom: 12px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .voice-wave.active {
      opacity: 1;
    }

    .voice-wave span {
      width: 4px;
      height: 16px;
      background: var(--cyan);
      border-radius: 2px;
      animation: wave 0.8s ease-in-out infinite;
    }

    .voice-wave span:nth-child(2) { animation-delay: 0.1s; height: 24px; }
    .voice-wave span:nth-child(3) { animation-delay: 0.2s; height: 12px; }
    .voice-wave span:nth-child(4) { animation-delay: 0.3s; height: 20px; }
    .voice-wave span:nth-child(5) { animation-delay: 0.4s; height: 14px; }

    @keyframes wave {
      0%, 100% { transform: scaleY(0.5); opacity: 0.5; }
      50% { transform: scaleY(1); opacity: 1; }
    }

    .voice-text {
      font-size: 11px;
      color: var(--text);
      text-align: center;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      will-change: opacity, transform;
    }

    .voice-text.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .input-source {
      text-align: center;
      margin-bottom: 8px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .input-source.visible {
      opacity: 1;
    }

    .source-badge {
      font-size: 9px;
      padding: 3px 8px;
      background: rgba(6, 182, 212, 0.15);
      color: var(--cyan);
      border-radius: 4px;
    }

    .whisper-step, .fifo-step {
      font-size: 9px;
      color: var(--text-dim);
      text-align: center;
      opacity: 0;
      transition: opacity 0.4s ease;
      margin: 6px 0;
    }

    .whisper-step.visible, .fifo-step.visible {
      opacity: 1;
      color: var(--cyan);
    }

    /* Processing column */
    .processing-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* LLM Council Card */
    .council-card .inner {
      background: var(--bg-inner);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .phase-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 8px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .phase-label.visible {
      opacity: 1;
      color: var(--purple);
    }

    .llm-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }

    .llm-box {
      flex: 1;
      background: #0d0f14;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #2a2d35;
      opacity: 0.3;
      transition: opacity 0.5s ease-out, border-color 0.5s ease-out, box-shadow 0.5s ease-out;
      will-change: opacity, border-color;
    }

    .llm-box.active {
      opacity: 1;
      border-color: var(--purple);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.15);
    }

    .llm-box .name {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .llm-box .name::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--purple);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .llm-box.active .name::before {
      opacity: 1;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    .llm-box .points {
      font-size: 9px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .llm-box .point {
      opacity: 0;
      transform: translateX(-5px);
      transition: all 0.3s ease;
    }

    .llm-box .point.visible {
      opacity: 1;
      transform: translateX(0);
    }

    /* Critique arrows */
    .critique-arrows {
      display: flex;
      justify-content: space-between;
      font-size: 8px;
      color: var(--text-dim);
      padding: 4px 10px;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .critique-arrows.visible {
      opacity: 1;
      color: var(--purple);
    }

    .debate-note {
      font-size: 8px;
      color: var(--text-dim);
      text-align: center;
      font-style: italic;
      opacity: 0;
      transition: opacity 0.4s ease;
      margin-bottom: 6px;
    }

    .debate-note.visible {
      opacity: 1;
    }

    /* PLAN.md output */
    .plan-output {
      background: #0d0f14;
      border-radius: 6px;
      padding: 10px;
      border-left: 2px solid var(--green);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      will-change: opacity, transform;
    }

    .plan-output.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .plan-output .filename {
      font-size: 9px;
      color: var(--green);
      margin-bottom: 6px;
    }

    .plan-output .items {
      font-size: 9px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .plan-output .item {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .plan-output .item.visible {
      opacity: 1;
    }

    /* Dispatcher Card */
    .dispatcher-card .inner {
      background: var(--bg-inner);
      border-radius: 8px;
      padding: 12px;
    }

    .router-line {
      font-size: 10px;
      color: var(--text-dim);
      padding: 8px;
      background: #0d0f14;
      border-radius: 4px;
      margin-bottom: 8px;
      opacity: 0;
      transition: all 0.4s ease;
      border-left: 2px solid transparent;
    }

    .router-line.visible {
      opacity: 1;
      border-left-color: var(--blue);
      color: var(--text);
    }

    .router-line .cmd {
      color: var(--blue);
    }

    /* Output column */
    .output-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Agent Status */
    .agent-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-inner);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 10px;
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.4s ease;
    }

    .agent-row.visible {
      opacity: 1;
      transform: translateX(0);
    }

    .agent-row .num {
      width: 20px;
      height: 20px;
      background: #0d0f14;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .agent-row .name {
      flex: 1;
      color: var(--text);
    }

    .agent-row .status {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .agent-row .status.ready {
      background: rgba(16, 185, 129, 0.15);
      color: var(--green);
    }

    .agent-row .status.working {
      background: rgba(245, 158, 11, 0.15);
      color: var(--amber);
    }

    .agent-row .complete {
      color: var(--green);
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .agent-row .complete.visible {
      opacity: 1;
    }

    /* Agent activity popouts */
    .agent-activity {
      position: absolute;
      left: 28px;
      top: 100%;
      margin-top: 2px;
      background: #0d0f14;
      border: 1px solid #3a3d45;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 8px;
      color: var(--text-muted);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 10;
    }

    .agent-activity.visible {
      opacity: 1;
    }

    .agent-activity .task {
      color: var(--amber);
    }

    .agent-row {
      position: relative;
    }

    /* Notification */
    .notification-card {
      position: relative;
    }

    .notification-content {
      background: linear-gradient(135deg, #1a2030, #0f1520);
      border: 1px solid #2a3545;
      border-radius: 8px;
      padding: 12px;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      will-change: opacity, transform;
    }

    .notification-content.visible {
      opacity: 1;
      transform: translateX(0);
    }

    .notif-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .notif-icon {
      width: 28px;
      height: 28px;
      background: rgba(16, 185, 129, 0.15);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .notif-title {
      font-size: 10px;
      color: var(--green);
      font-weight: 600;
    }

    .notif-text {
      font-size: 9px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .notif-channels {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .notif-badge {
      font-size: 8px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.05);
      color: var(--text-dim);
    }

    .notif-summary {
      font-size: 9px;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #2a2d35;
    }

    .notif-summary strong {
      color: var(--green);
    }

    .notif-next {
      font-size: 9px;
      color: var(--cyan);
      margin-bottom: 8px;
    }

    .notif-next strong {
      color: var(--amber);
    }

    .loop-indicator {
      margin-top: 12px;
      padding: 8px 10px;
      background: rgba(6, 182, 212, 0.1);
      border: 1px dashed var(--cyan);
      border-radius: 6px;
      font-size: 9px;
      color: var(--cyan);
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .loop-indicator.visible {
      opacity: 1;
    }

    .loop-arrow {
      font-size: 12px;
      margin-right: 4px;
    }

    /* Terminal */
    .terminal-section {
      grid-column: 1 / -1;
      margin-top: 16px;
    }

    .terminal-grid-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .terminal-card {
      background: #0d0f14;
      border: 1px solid #2a2d35;
      border-radius: 8px;
      overflow: hidden;
    }

    .terminal-header {
      background: var(--bg-inner);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #2a2d35;
    }

    .terminal-dots {
      display: flex;
      gap: 5px;
    }

    .terminal-dots span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #3a3d45;
    }

    .terminal-dots span:nth-child(1) { background: #ff5f56; }
    .terminal-dots span:nth-child(2) { background: #ffbd2e; }
    .terminal-dots span:nth-child(3) { background: #27ca40; }

    .terminal-title {
      font-size: 10px;
      color: var(--text-muted);
      flex: 1;
      text-align: center;
    }

    .terminal-body {
      padding: 14px;
      font-size: 11px;
      min-height: 140px;
      line-height: 1.7;
    }

    .terminal-line {
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      will-change: opacity, transform;
    }

    .terminal-line.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .terminal-line .prompt {
      color: var(--green);
    }

    .terminal-line .cmd {
      color: var(--cyan);
    }

    .terminal-line .output {
      color: var(--text-muted);
      padding-left: 18px;
    }

    .terminal-line .success {
      color: var(--green);
    }

    .terminal-line .subagent {
      color: var(--purple);
    }

    .terminal-line .hook {
      color: var(--green);
    }

    .terminal-line .ralph {
      color: var(--amber);
      font-weight: 600;
    }

    .terminal-line .question {
      color: var(--cyan);
    }

    .terminal-line .prompt.question {
      color: var(--cyan);
      font-weight: 600;
    }

    /* Timeline indicator */
    .timeline {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      padding: 10px 20px;
      border-radius: 20px;
      border: 1px solid #2a2d35;
    }

    .timeline-bar {
      width: 200px;
      height: 4px;
      background: #2a2d35;
      border-radius: 2px;
      overflow: hidden;
    }

    .timeline-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--cyan), var(--purple), var(--blue), var(--green));
      width: 0%;
      transition: width 0.1s linear;
    }

    .timeline-time {
      font-size: 10px;
      color: var(--text-muted);
      min-width: 40px;
    }

    .timeline-btn {
      background: var(--bg-inner);
      border: 1px solid #3a3d45;
      border-radius: 4px;
      padding: 4px 10px;
      color: var(--text-muted);
      font-size: 10px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .timeline-btn:hover {
      border-color: var(--purple);
      color: var(--text);
    }

    /* Mini terminals */
    .mini-terminal {
      background: #0d0f14;
      border: 1px solid #2a2d35;
      border-radius: 6px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      will-change: opacity, transform;
      overflow: hidden;
    }

    .mini-terminal.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .mini-terminal-header {
      background: var(--bg-inner);
      padding: 5px 10px;
      font-size: 8px;
      color: var(--text-dim);
      border-bottom: 1px solid #2a2d35;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mini-terminal-header .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--amber);
      animation: pulse 1s infinite;
    }

    .mini-terminal.done .dot {
      background: var(--green);
      animation: none;
    }

    .mini-terminal-body {
      padding: 8px 10px;
      font-size: 9px;
      line-height: 1.6;
    }

    .mini-line {
      opacity: 0;
      transition: opacity 0.5s ease-out;
      will-change: opacity;
    }

    .mini-line.visible {
      opacity: 1;
    }

    .mini-line .prompt {
      color: var(--green);
    }

    .mini-line .cmd {
      color: var(--cyan);
    }

    .mini-line .out {
      color: var(--text-muted);
      padding-left: 10px;
      display: block;
    }

    .mini-line .success {
      color: var(--green);
    }

    /* Flow trail animation */
    .flow-trail {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
    }

    .flow-line {
      fill: none;
      stroke-width: 1;
      stroke-linecap: round;
      opacity: 0;
      stroke-dasharray: 3 6;
      transition: opacity 0.8s ease-in-out;
      will-change: opacity, stroke-dashoffset;
    }

    .flow-line.cyan {
      stroke: rgba(6, 182, 212, 0.5);
    }

    .flow-line.purple {
      stroke: rgba(139, 92, 246, 0.5);
    }

    .flow-line.blue {
      stroke: rgba(59, 130, 246, 0.5);
    }

    .flow-line.green {
      stroke: rgba(16, 185, 129, 0.6);
      stroke-dasharray: 2 4;
    }

    .flow-line.active {
      opacity: 1;
      animation: dataFlow 0.8s linear infinite;
    }

    .flow-line.fade-out {
      opacity: 0;
    }

    @keyframes dataFlow {
      to { stroke-dashoffset: -9; }
    }

    /* Stage label */
    .stage-label {
      position: fixed;
      top: 20px;
      right: 30px;
      font-size: 11px;
      color: var(--text-dim);
      background: var(--bg-card);
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #2a2d35;
      opacity: 0;
      transition: all 0.4s ease;
    }

    .stage-label.visible {
      opacity: 1;
    }

    .stage-label .stage {
      color: var(--purple);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Flow Trail SVG -->
  <svg class="flow-trail" id="flow-trail">
    <!-- Flow paths added dynamically -->
  </svg>

  <!-- Header -->
  <div class="header">
    <h1>Council v3 Demo</h1>
    <div class="flow-bar">
      <span id="flow-voice">Voice</span>
      <span class="arrow">-></span>
      <span id="flow-council">Council</span>
      <span class="arrow">-></span>
      <span id="flow-dispatcher">Dispatcher</span>
      <span class="arrow">-></span>
      <span id="flow-agents">Agents</span>
      <span class="arrow">-></span>
      <span id="flow-notify">Notification</span>
    </div>
  </div>

  <!-- Stage Label -->
  <div class="stage-label" id="stage-label">
    <span class="stage" id="stage-text">Voice Input</span>
  </div>

  
  <!-- Main 3-column layout -->
  <div class="main-container">
    <!-- Input Column -->
    <div class="input-column">
      <div class="card voice-card cyan" id="voice-card">
        <div class="card-title">ðŸ’¬ Telegram Input</div>
        <div class="content">
          <div class="input-source" id="input-source">
            <span class="source-badge">Voice Message</span>
          </div>
          <div class="voice-wave" id="voice-wave">
            <span></span><span></span><span></span><span></span><span></span>
          </div>
          <div class="whisper-step" id="whisper-step">Wispr Flow â†’ transcribe</div>
          <div class="voice-text" id="voice-text">"1: Build rate limiting middleware for the API"</div>
          <div class="fifo-step" id="fifo-step">â†’ FIFO pipe</div>
        </div>
      </div>
    </div>

    <!-- Processing Column -->
    <div class="processing-column">
      <!-- LLM Council Card -->
      <div class="card council-card purple" id="council-card">
        <div class="card-title">LLM Council <span style="font-size:7px;color:#64748b;font-weight:normal;margin-left:4px">(large new features, MVPs â€“ use /plan for smaller tasks)</span></div>

        <div class="phase-label" id="phase-draft">Phase 1: Draft</div>

        <div class="inner">
          <div class="llm-row">
            <div class="llm-box" id="claude-box">
              <div class="name">Opus 4.5</div>
              <div class="points">
                <div class="point" id="claude-1">- Token bucket algorithm</div>
                <div class="point" id="claude-2">- Redis for distributed state</div>
                <div class="point" id="claude-3">- Per-user + global limits</div>
              </div>
            </div>
            <div class="llm-box" id="gpt-box">
              <div class="name">GPT-5.2</div>
              <div class="points">
                <div class="point" id="gpt-1">- Sliding window counter instead</div>
                <div class="point" id="gpt-2">- 429 response with Retry-After</div>
                <div class="point" id="gpt-3">- Bypass for internal services</div>
              </div>
            </div>
          </div>
        </div>

        <div class="phase-label" id="phase-critique">Phase 2: Critique (Debate)</div>
        <div class="critique-arrows" id="critique-arrows">
          <span class="arrow-left">Claude â†’ GPT</span>
          <span class="arrow-right">GPT â†’ Claude</span>
        </div>
        <div class="debate-note" id="debate-note">Models challenge each other's assumptions</div>
        <div class="phase-label" id="phase-synthesis">Phase 3: Chair Synthesis</div>

        <div class="plan-output" id="plan-output">
          <div class="filename">PLAN.md</div>
          <div class="items">
            <div class="item" id="plan-1">1. RateLimiter class with sliding window</div>
            <div class="item" id="plan-2">2. Redis backend for distributed counting</div>
            <div class="item" id="plan-3">3. Middleware wrapper with 429 + Retry-After</div>
            <div class="item" id="plan-4">4. Config: 100 req/min user, 1000 req/min global</div>
          </div>
        </div>
      </div>

      <!-- Dispatcher Card -->
      <div class="card dispatcher-card blue" id="dispatcher-card">
        <div class="card-title">Dispatcher</div>
        <div class="inner">
          <div class="router-line" id="router-line">
            Routing: <span class="cmd">1: build rate limiter per PLAN.md</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Output Column -->
    <div class="output-column">
      <!-- Notification -->
      <div class="card notification-card amber" id="notify-card">
        <div class="card-title">Notification</div>
        <div class="notification-content" id="notification">
          <div class="notif-header">
            <div class="notif-icon">âœ…</div>
            <div class="notif-title">â†’ Pushed to Phone</div>
          </div>
          <div class="notif-summary" id="notif-summary">
            <strong>Done:</strong> Rate limiting middleware<br>
            â€¢ 3 files â€¢ 12 tests â€¢ Redis backend
          </div>
          <div class="notif-next" id="notif-next">
            <strong>Next:</strong> Add dashboard for rate limit metrics?
          </div>
          <div class="notif-channels">
            <span class="notif-badge">Pushover</span>
            <span class="notif-badge">Mac Notification</span>
          </div>
        </div>
        <div class="loop-indicator" id="loop-indicator">
          <span class="loop-arrow">â†©</span> Your reply starts next cycle
        </div>
      </div>
    </div>

    <!-- Terminal Section - Grid Layout -->
    <div class="terminal-section">
      <!-- Top row: Agents 2 and 3 -->
      <div class="terminal-grid-top">
        <div class="mini-terminal" id="mini-term-2">
          <div class="mini-terminal-header">
            <span class="dot"></span>
            Agent 2 Â· codeflow-viz
          </div>
          <div class="mini-terminal-body">
            <div class="mini-line" id="m2-1"><span class="prompt">></span> TourStep.tsx in progress</div>
            <div class="mini-line" id="m2-2"><span class="out">Adding highlight overlay...</span></div>
            <div class="mini-line" id="m2-3"><span class="prompt">></span> Wiring navigation hooks</div>
            <div class="mini-line" id="m2-4"><span class="out success">âœ“ Tour component ready</span></div>
          </div>
        </div>
        <div class="mini-terminal" id="mini-term-3">
          <div class="mini-terminal-header">
            <span class="dot"></span>
            Agent 3 Â· deep-research
          </div>
          <div class="mini-terminal-body">
            <div class="mini-line" id="m3-1"><span class="prompt">></span> Eval harness in progress</div>
            <div class="mini-line" id="m3-2"><span class="out">Writing metrics.py...</span></div>
            <div class="mini-line" id="m3-3"><span class="prompt">></span> Running eval on 25 facts</div>
            <div class="mini-line" id="m3-4"><span class="out success">âœ“ Eval harness complete</span></div>
          </div>
        </div>
      </div>

      <!-- Bottom row: Agent 1 (main) -->
      <div class="terminal-card" id="terminal-card">
        <div class="terminal-header">
          <div class="terminal-dots">
            <span></span><span></span><span></span>
          </div>
          <div class="terminal-title">Agent 1 Â· council-v3</div>
        </div>
        <div class="terminal-body">
          <div class="terminal-line" id="term-1">
            <span class="prompt">></span> Created ratelimit.py + redis_backend.py
          </div>
          <div class="terminal-line" id="term-2">
            <span class="prompt">></span> Added middleware.py with 429 handling
          </div>
          <div class="terminal-line" id="term-3">
            <span class="prompt">$</span> <span class="cmd">/test</span> <span class="output">pytest tests/ -v</span>
          </div>
          <div class="terminal-line" id="term-4">
            <span class="output success">âœ“ 97 passed (5.2s) - 12 new rate limit tests</span>
          </div>
          <div class="terminal-line" id="term-5">
            <span class="prompt">$</span> <span class="subagent">verify-app</span> <span class="output">load testing limits</span>
          </div>
          <div class="terminal-line" id="term-6">
            <span class="output success">âœ“ 429s returned correctly at threshold</span>
          </div>
          <div class="terminal-line" id="term-7">
            <span class="prompt">$</span> <span class="hook">PostToolUse</span> <span class="output">black + isort</span>
          </div>
          <div class="terminal-line" id="term-8">
            <span class="prompt">$</span> <span class="cmd">/ship</span> <span class="output">test â†’ commit â†’ push</span>
          </div>
          <div class="terminal-line" id="term-9">
            <span class="output success">âœ“ "Add rate limiting middleware" â†’ main</span>
          </div>
          <div class="terminal-line" id="term-10">
            <span class="prompt">$</span> <span class="ralph">Ralph</span> <span class="output">auto-continue...</span>
          </div>
          <div class="terminal-line" id="term-11">
            <span class="prompt">$</span> <span class="cmd">/review</span> <span class="output">spawning review subagent</span>
          </div>
          <div class="terminal-line" id="term-12">
            <span class="output success">âœ“ Code review passed</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timeline -->
  <div class="timeline">
    <button class="timeline-btn" id="restart-btn">Restart</button>
    <div class="timeline-bar">
      <div class="timeline-progress" id="timeline-progress"></div>
    </div>
    <div class="timeline-time" id="timeline-time">0:00</div>
  </div>

  <script>
    // Animation timeline (28 seconds total)
    const TOTAL_DURATION = 28000;
    let startTime = null;
    let animationFrame = null;
    let currentStep = -1;

    // Timeline steps with their start times (in ms)
    const steps = [
      // Voice input (0-3s)
      { time: 0, action: () => {
        // Other agents already mid-progress from the start
        document.getElementById('mini-term-2').classList.add('visible');
        document.getElementById('mini-term-3').classList.add('visible');
        document.getElementById('m2-1').classList.add('visible');
        document.getElementById('m2-2').classList.add('visible');
        document.getElementById('m3-1').classList.add('visible');
        setStage('Phone Input');
        setFlowActive('voice');
        document.getElementById('voice-card').classList.add('active');
        document.getElementById('input-source').classList.add('visible');
      }},
      { time: 400, action: () => {
        document.getElementById('voice-wave').classList.add('active');
      }},
      { time: 800, action: () => {
        document.getElementById('whisper-step').classList.add('visible');
      }},
      { time: 1200, action: () => {
        document.getElementById('voice-text').classList.add('visible');
      }},
      { time: 1800, action: () => {
        document.getElementById('fifo-step').classList.add('visible');
      }},
      { time: 2500, action: () => {
        drawVoiceToCouncil();
      }},

      // LLM Council (3-8s)
      { time: 3000, action: () => {
        setStage('LLM Council - Draft');
        setFlowActive('council');
        document.getElementById('council-card').classList.add('active');
        document.getElementById('phase-draft').classList.add('visible');
        document.getElementById('claude-box').classList.add('active');
      }},
      { time: 3500, action: () => document.getElementById('claude-1').classList.add('visible') },
      { time: 3800, action: () => document.getElementById('claude-2').classList.add('visible') },
      { time: 4100, action: () => document.getElementById('claude-3').classList.add('visible') },
      { time: 4500, action: () => {
        document.getElementById('gpt-box').classList.add('active');
      }},
      { time: 4800, action: () => document.getElementById('gpt-1').classList.add('visible') },
      { time: 5100, action: () => document.getElementById('gpt-2').classList.add('visible') },
      { time: 5400, action: () => document.getElementById('gpt-3').classList.add('visible') },
      { time: 5800, action: () => {
        setStage('LLM Council - Critique');
        document.getElementById('phase-critique').classList.add('visible');
      }},
      { time: 6200, action: () => {
        document.getElementById('critique-arrows').classList.add('visible');
      }},
      { time: 6600, action: () => {
        document.getElementById('debate-note').classList.add('visible');
      }},
      { time: 7200, action: () => {
        setStage('LLM Council - Synthesis');
        document.getElementById('phase-synthesis').classList.add('visible');
      }},
      { time: 7600, action: () => {
        document.getElementById('plan-output').classList.add('visible');
        document.getElementById('plan-1').classList.add('visible');
      }},
      { time: 7900, action: () => document.getElementById('plan-2').classList.add('visible') },
      { time: 8200, action: () => document.getElementById('plan-3').classList.add('visible') },
      { time: 8500, action: () => document.getElementById('plan-4').classList.add('visible') },

      // Dispatcher (9-13s)
      { time: 8700, action: () => {
        drawCouncilToDispatcher();
      }},
      { time: 9000, action: () => {
        setStage('Dispatcher Routing');
        setFlowActive('dispatcher');
        document.getElementById('dispatcher-card').classList.add('active');
        document.getElementById('router-line').classList.add('visible');
      }},
      { time: 10200, action: () => {
        drawDispatcherToAgent();
      }},
      { time: 10000, action: () => {
        setStage('Agent Assignment');
        setFlowActive('agents');
      }},

      // Terminal work (13-24s)
      { time: 13000, action: () => {
        setStage('Agents Executing');
        document.getElementById('term-1').classList.add('visible');
      }},
      { time: 14000, action: () => document.getElementById('term-2').classList.add('visible') },
      { time: 15000, action: () => document.getElementById('term-3').classList.add('visible') },
      { time: 15800, action: () => document.getElementById('term-4').classList.add('visible') },
      { time: 16600, action: () => document.getElementById('term-5').classList.add('visible') },
      { time: 17400, action: () => document.getElementById('term-6').classList.add('visible') },
      { time: 18200, action: () => document.getElementById('term-7').classList.add('visible') },
      { time: 19000, action: () => document.getElementById('term-8').classList.add('visible') },

      // Spread mini terminal progress throughout (agents 2 & 3 work independently)
      { time: 6000, action: () => document.getElementById('m3-2').classList.add('visible') },
      { time: 12000, action: () => document.getElementById('m2-3').classList.add('visible') },
      { time: 14000, action: () => document.getElementById('m3-3').classList.add('visible') },
      { time: 17000, action: () => {
        document.getElementById('m2-4').classList.add('visible');
        document.getElementById('mini-term-2').classList.add('done');
      }},
      { time: 20000, action: () => {
        document.getElementById('m3-4').classList.add('visible');
        document.getElementById('mini-term-3').classList.add('done');
      }},
      { time: 19800, action: () => document.getElementById('term-9').classList.add('visible') },
      { time: 20600, action: () => document.getElementById('term-10').classList.add('visible') },
      { time: 21400, action: () => document.getElementById('term-11').classList.add('visible') },

      // Question and loop (21-27s)
      { time: 21500, action: () => document.getElementById('term-12').classList.add('visible') },
      { time: 22000, action: () => {
        drawAgentToNotification();
      }},
      { time: 22500, action: () => {
        setStage('Follow-up Question');
        setFlowActive('notify');
        document.getElementById('notify-card').classList.add('active');
        document.getElementById('notification').classList.add('visible');
      }},
      { time: 24000, action: () => {
        document.getElementById('loop-indicator').classList.add('visible');
      }},
      { time: 25500, action: () => {
        setStage('Loop â†’ Reply starts new cycle');
        // Highlight the input card to show the loop
        document.getElementById('voice-card').style.boxShadow = '0 0 20px rgba(6, 182, 212, 0.4)';
      }},
          ];

    function setStage(text) {
      const label = document.getElementById('stage-label');
      const stageText = document.getElementById('stage-text');
      stageText.textContent = text;
      label.classList.add('visible');
    }

    function setFlowActive(step) {
      ['voice', 'council', 'dispatcher', 'agents', 'notify'].forEach(s => {
        document.getElementById(`flow-${s}`).classList.remove('active');
      });
      document.getElementById(`flow-${step}`).classList.add('active');
    }

    // Flow line animation
    const flowTrail = document.getElementById('flow-trail');
    let currentFlowLine = null;
    let flowAnimation = null;

    // Create a flow line and auto-fade after duration
    function createFlowLine(d, colorClass, fadeAfter = 2000) {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', d);
      path.classList.add('flow-line', colorClass, 'active');
      flowTrail.appendChild(path);

      // Auto-fade after duration
      setTimeout(() => {
        path.classList.remove('active');
        path.classList.add('fade-out');
        setTimeout(() => path.remove(), 600);
      }, fadeAfter);
    }

    // Flow 1: Voice (left) â†’ Council (middle) - horizontal route
    function drawVoiceToCouncil() {
      const voice = document.getElementById('voice-card').getBoundingClientRect();
      const council = document.getElementById('council-card').getBoundingClientRect();

      const startX = voice.right;
      const startY = voice.top + voice.height * 0.4;
      const endX = council.left;
      const endY = council.top + 40;

      // Simple horizontal curve
      const midX = (startX + endX) / 2;
      const d = `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`;

      createFlowLine(d, 'cyan', 2500);
    }

    // Flow 2: Council â†’ Dispatcher - vertical, same column
    function drawCouncilToDispatcher() {
      const council = document.getElementById('council-card').getBoundingClientRect();
      const dispatcher = document.getElementById('dispatcher-card').getBoundingClientRect();

      const startX = council.left + council.width / 2;
      const startY = council.bottom;
      const endX = dispatcher.left + dispatcher.width / 2;
      const endY = dispatcher.top;

      // Simple vertical line with slight curve
      const midY = (startY + endY) / 2;
      const d = `M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}`;

      createFlowLine(d, 'purple', 2000);
    }

    // Flow 3: Dispatcher â†’ Agent 1 - route around mini terminals on the LEFT
    function drawDispatcherToAgent() {
      const dispatcher = document.getElementById('dispatcher-card').getBoundingClientRect();
      const terminal = document.getElementById('terminal-card').getBoundingClientRect();
      const miniTerm2 = document.getElementById('mini-term-2').getBoundingClientRect();

      // Start from left side of dispatcher (to go around left)
      const startX = dispatcher.left;
      const startY = dispatcher.bottom - 10;

      // End at left edge of Agent 1 terminal, vertically centered
      const endX = terminal.left;
      const endY = terminal.top + terminal.height / 2;

      // Route: go left, then down past mini terminals, then right to terminal
      const leftEdge = miniTerm2.left - 25; // 25px margin from mini terminal

      const d = `M ${startX} ${startY}
                 L ${leftEdge} ${startY}
                 L ${leftEdge} ${endY}
                 L ${endX} ${endY}`;

      createFlowLine(d, 'blue', 3000);
    }

    // Flow 4: Agent 1 â†’ Notification - route UP then RIGHT (above mini terminals)
    function drawAgentToNotification() {
      const terminal = document.getElementById('terminal-card').getBoundingClientRect();
      const notify = document.getElementById('notify-card').getBoundingClientRect();
      const miniTerm3 = document.getElementById('mini-term-3').getBoundingClientRect();

      // Start from right side of terminal header area
      const startX = terminal.right;
      const startY = terminal.top + 20;

      // End at bottom of notification
      const endX = notify.left + notify.width / 2;
      const endY = notify.bottom;

      // Route: go right, then up to notification
      // Stay to the right of mini-term-3
      const rightEdge = miniTerm3.right + 20;
      const topRoute = miniTerm3.top - 15;

      const d = `M ${startX} ${startY}
                 L ${rightEdge} ${startY}
                 L ${rightEdge} ${topRoute}
                 L ${endX} ${topRoute}
                 L ${endX} ${endY}`;

      createFlowLine(d, 'green', 2000);
    }

    function fadeAllFlowLines() {
      document.querySelectorAll('.flow-line').forEach(line => {
        line.classList.remove('active');
        line.classList.add('fade-out');
        setTimeout(() => line.remove(), 600);
      });
    }

    function updateTimeline(elapsed) {
      const progress = Math.min(elapsed / TOTAL_DURATION * 100, 100);
      document.getElementById('timeline-progress').style.width = progress + '%';

      const seconds = Math.floor(elapsed / 1000);
      const ms = Math.floor((elapsed % 1000) / 10);
      document.getElementById('timeline-time').textContent =
        `${seconds}:${ms.toString().padStart(2, '0')}`;
    }

    function animate(timestamp) {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;

      updateTimeline(elapsed);

      // Execute steps that have reached their time
      while (currentStep < steps.length - 1 && steps[currentStep + 1].time <= elapsed) {
        currentStep++;
        steps[currentStep].action();
      }

      if (elapsed < TOTAL_DURATION) {
        animationFrame = requestAnimationFrame(animate);
      }
    }

    function reset() {
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
      startTime = null;
      currentStep = -1;

      // Reset all elements
      document.querySelectorAll('.active, .visible').forEach(el => {
        el.classList.remove('active', 'visible');
      });

      // Reset voice card glow
      document.getElementById('voice-card').style.boxShadow = 'none';

      // Reset mini terminals
      document.getElementById('mini-term-2').classList.remove('done');
      document.getElementById('mini-term-3').classList.remove('done');

      // Remove all flow lines immediately
      document.querySelectorAll('.flow-line').forEach(line => line.remove());
      currentFlowLine = null;
      if (flowAnimation) {
        cancelAnimationFrame(flowAnimation);
        flowAnimation = null;
      }

      // Reset flow bar
      ['voice', 'council', 'dispatcher', 'agents', 'notify'].forEach(s => {
        document.getElementById(`flow-${s}`).classList.remove('active');
      });

      updateTimeline(0);
    }

    function start() {
      reset();
      animationFrame = requestAnimationFrame(animate);
    }

    // Event listeners
    document.getElementById('restart-btn').addEventListener('click', start);

    // Auto-start on load
    window.addEventListener('load', () => {
      setTimeout(start, 500);
    });
  </script>
</body>
</html>
