<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier-3 System Walkthrough</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'SF Mono', 'Consolas', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 2rem;
            line-height: 1.6;
        }
        h1 { color: #58a6ff; margin-bottom: 1rem; }
        h2 { color: #8b949e; margin: 2rem 0 1rem; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 0 auto; }

        .step {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            position: relative;
        }
        .step.active { border-color: #58a6ff; }
        .step.success { border-color: #3fb950; }
        .step.failure { border-color: #f85149; }
        .step.warning { border-color: #d29922; }

        .step-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .step-number {
            background: #30363d;
            color: #8b949e;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .step.active .step-number { background: #58a6ff; color: #0d1117; }
        .step.success .step-number { background: #3fb950; color: #0d1117; }
        .step.failure .step-number { background: #f85149; color: #0d1117; }

        .step-title { font-weight: bold; color: #f0f6fc; }

        .terminal {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
        }
        .terminal pre { white-space: pre-wrap; }
        .prompt { color: #8b949e; }
        .command { color: #79c0ff; }
        .output { color: #c9d1d9; }
        .success-text { color: #3fb950; }
        .error-text { color: #f85149; }
        .warning-text { color: #d29922; }
        .dim { color: #484f58; }

        .flow-arrow {
            text-align: center;
            color: #30363d;
            font-size: 1.5rem;
            margin: 0.5rem 0;
        }

        .component-diagram {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .component {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        .component-name { color: #58a6ff; font-weight: bold; margin-bottom: 0.5rem; }
        .component-desc { color: #8b949e; font-size: 0.85rem; }

        .config-box {
            background: #1c2128;
            border-left: 3px solid #58a6ff;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.85rem;
        }
        .config-box code { color: #79c0ff; }

        .scenario { margin: 2rem 0; }
        .scenario-title {
            background: #21262d;
            padding: 0.75rem 1rem;
            border-radius: 6px 6px 0 0;
            border: 1px solid #30363d;
            border-bottom: none;
            font-weight: bold;
        }
        .scenario-content {
            border: 1px solid #30363d;
            border-radius: 0 0 6px 6px;
            padding: 1rem;
        }

        .status-line {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 0.5rem 0;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .badge-ready { background: #238636; }
        .badge-working { background: #1f6feb; }
        .badge-done { background: #3fb950; color: #0d1117; }
        .badge-waiting { background: #d29922; color: #0d1117; }
        .badge-failed { background: #f85149; }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: -1px;
        }
        .tab {
            padding: 0.5rem 1rem;
            background: #21262d;
            border: 1px solid #30363d;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            color: #8b949e;
        }
        .tab.active {
            background: #161b22;
            color: #f0f6fc;
            border-bottom-color: #161b22;
        }
        .tab-content {
            display: none;
            border: 1px solid #30363d;
            border-radius: 0 6px 6px 6px;
            padding: 1rem;
            background: #161b22;
        }
        .tab-content.active { display: block; }

        .highlight-box {
            background: #1c2128;
            border: 2px dashed #58a6ff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .highlight-box h3 {
            color: #58a6ff;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tier-3 Authoritative Completion System</h1>
        <p style="color: #8b949e; margin-bottom: 2rem;">
            How council-v3 verifies task completion through infrastructure, not trust.
        </p>

        <!-- Architecture Overview -->
        <h2>System Components</h2>
        <div class="component-diagram">
            <div class="component">
                <div class="component-name">Dispatcher</div>
                <div class="component-desc">Routes commands, monitors agents, detects DONE_REPORT</div>
            </div>
            <div class="component">
                <div class="component-name">Transcript JSONL</div>
                <div class="component-desc">Claude Code session log (source of truth)</div>
            </div>
            <div class="component">
                <div class="component-name">check_invariants.py</div>
                <div class="component-desc">Validates git diff against rules</div>
            </div>
            <div class="component">
                <div class="component-name">audit_done.py</div>
                <div class="component-desc">Verifies DONE_REPORT claims match evidence</div>
            </div>
        </div>

        <!-- Config Example -->
        <h2>Agent Configuration (strict mode + auto-audit)</h2>
        <div class="config-box">
<pre>agents:
  1:
    pane_id: "%0"
    name: "CodeflowViz"
    worktree: ~/projects/codeflow
    <code>mode: strict</code>                    # DONE_REPORT required
    <code>transcript_path</code>: ~/.claude/projects/.../session.jsonl
    <code>auto_audit: true</code>               # Run audit on completion
    <code>invariants_path</code>: ~/.council/invariants.yaml</pre>
        </div>

        <!-- Scenario 1: Happy Path -->
        <div class="scenario">
            <div class="scenario-title" style="background: #238636;">Scenario 1: Happy Path (Task Approved)</div>
            <div class="scenario-content">

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Operator sends task</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">1: Add error handling to api.py</span>
<span class="output">Sending to Agent 1 (CodeflowViz)...</span>
<span class="dim">Agent enters strict mode, awaiting_done_report = True</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Agent works (dispatcher polls)</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">status</span>
<span class="output">Agent 1 (CodeflowViz): <span class="warning-text">working</span> [awaiting DONE_REPORT]</span>
<span class="dim">                       ↑ tmux shows no prompt</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">Agent completes with DONE_REPORT</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># Agent outputs to transcript:</span>
<span class="output">DONE_REPORT:
- changed_files: [src/api.py]
- commands_run: [pytest tests/ -v (exit 0)]
- test_output: "15 passed"
- invariants: "clean"
- next_actions: []</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step active">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">Dispatcher detects DONE_REPORT (tail-bytes search)</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># check_done_report() runs:</span>
<span class="output">Transcript: ~/.claude/projects/.../session.jsonl</span>
<span class="output">Size: 245,000 bytes</span>
<span class="output">Reading last 500KB...</span>
<span class="success-text">Found "DONE_REPORT" in transcript</span>
<span class="output">agent.awaiting_done_report = False</span>
<span class="output">agent.last_done_report_ts = 1705234567.89</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step active">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <div class="step-title">Auto-audit triggers (auto_audit = true)</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># run_auto_audit() runs:</span>

<span class="prompt">$</span> <span class="command">python3 council/enforcement/check_invariants.py</span>
<span class="success-text">Invariants: PASS (0 violations)</span>

<span class="prompt">$</span> <span class="command">python3 council/enforcement/audit_done.py --transcript session.jsonl</span>
<span class="output">Checking: changed_files claim matches git diff... <span class="success-text">OK</span></span>
<span class="output">Checking: test_output claim matches Bash output... <span class="success-text">OK</span></span>
<span class="output">Checking: invariants claim matches check... <span class="success-text">OK</span></span>
<span class="success-text">AUDIT: VERIFIED - all claims match evidence</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step success">
                    <div class="step-header">
                        <div class="step-number">6</div>
                        <div class="step-title">Task approved</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">status</span>
<span class="output">Agent 1 (CodeflowViz): <span class="success-text">ready</span> [DONE <span class="success-text">2m ago</span>] <span class="success-text">APPROVED</span></span></pre>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="status-line">
                            <span class="status-badge badge-ready">ready</span>
                            <span class="status-badge badge-done">DONE 2m ago</span>
                            <span class="status-badge" style="background: #3fb950; color: #0d1117;">APPROVED</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Scenario 2: Audit Failure -->
        <div class="scenario">
            <div class="scenario-title" style="background: #f85149;">Scenario 2: Audit Failure (Loop Guard Kicks In)</div>
            <div class="scenario-content">

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Agent claims tests passed, but they didn't</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># Agent's DONE_REPORT:</span>
<span class="output">DONE_REPORT:
- changed_files: [src/api.py]
- commands_run: [pytest tests/ -v (exit 0)]  <span class="error-text">← LIE</span>
- test_output: "15 passed"                   <span class="error-text">← LIE</span>
- invariants: "clean"
- next_actions: []</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step failure">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Auto-audit catches the discrepancy</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">$</span> <span class="command">python3 council/enforcement/audit_done.py --transcript session.jsonl</span>
<span class="output">Checking: test_output claim matches Bash output...</span>
<span class="error-text">DISCREPANCY: Claimed "15 passed" but Bash output shows:</span>
<span class="error-text">  "FAILED tests/test_api.py::test_error_handling - AssertionError"</span>
<span class="error-text">  "1 failed, 14 passed"</span>
<span class="error-text">AUDIT: REJECTED - claims don't match evidence</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step warning">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">First failure: auto-queue fix task</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># run_auto_audit() logic:</span>
<span class="output">audit_fail_streak = 1</span>
<span class="output">last_audit_task_id = "a7f3b2c1"</span>
<span class="warning-text">Auto-queuing: "Fix audit issues: test_output mismatch"</span>

<span class="prompt">council&gt;</span> <span class="command">status</span>
<span class="output">Agent 1 (CodeflowViz): <span class="warning-text">working</span> Q:1 [REJECTED - fixing]</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">Agent tries to fix, submits new DONE_REPORT</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># Agent still lies (or can't fix the issue):</span>
<span class="output">DONE_REPORT:
- test_output: "15 passed"  <span class="error-text">← STILL A LIE</span></span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step failure">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <div class="step-title">Loop guard prevents infinite retries</div>
                    </div>
                    <div class="terminal">
<pre><span class="dim"># run_auto_audit() logic:</span>
<span class="output">task_id = "a7f3b2c1" (same task)</span>
<span class="output">audit_fail_streak = 1</span>
<span class="output">MAX_AUDIT_RETRIES = 1</span>
<span class="error-text">audit_fail_streak >= MAX_AUDIT_RETRIES</span>
<span class="error-text">→ DO NOT auto-queue (human intervention required)</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step failure">
                    <div class="step-header">
                        <div class="step-number">6</div>
                        <div class="step-title">Escalate to human operator</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">status</span>
<span class="output">Agent 1 (CodeflowViz): <span class="error-text">ready</span> [<span class="error-text">REQUIRES HUMAN</span>]</span>
<span class="error-text">  Audit failed 2 times. Manual intervention required.</span>
<span class="error-text">  Last rejection: test_output mismatch</span></pre>
                    </div>
                    <div style="margin-top: 1rem;">
                        <div class="status-line">
                            <span class="status-badge badge-ready">ready</span>
                            <span class="status-badge badge-failed">REQUIRES HUMAN</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Scenario 3: Review Mode -->
        <div class="scenario">
            <div class="scenario-title" style="background: #1f6feb;">Scenario 3: Review Mode (Missing Evidence)</div>
            <div class="scenario-content">

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Operator activates review mode</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">claude&gt;</span> <span class="command">/inject review</span>
<span class="output">Injection mode set to review. This will apply to all prompts until changed.</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Operator asks for review without evidence</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">claude&gt;</span> <span class="command">Review the API changes</span>
<span class="dim"># No git diff, no test results provided</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step failure">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">Review mode rejects (hard input contract)</div>
                    </div>
                    <div class="terminal">
<pre><span class="error-text">REJECT: Missing evidence: [git diff, test results]. Cannot review without artifacts.</span>

<span class="dim">Required inputs for review mode:</span>
<span class="output">- git diff output</span>
<span class="output">- test results (pass/fail + output)</span>
<span class="output">- invariants check result (or "not configured")</span></pre>
                    </div>
                </div>

                <div class="flow-arrow">↓</div>

                <div class="step success">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">Operator provides evidence, review proceeds</div>
                    </div>
                    <div class="terminal">
<pre><span class="prompt">claude&gt;</span> <span class="command">Review the API changes</span>

<span class="command">git diff:</span>
<span class="output">+    try:
+        result = api.call(endpoint)
+    except ApiError as e:
+        logger.error(f"API failed: {e}")
+        raise</span>

<span class="command">test results:</span>
<span class="output">15 passed</span>

<span class="command">invariants:</span>
<span class="output">clean</span>

<span class="dim"># Review proceeds with evidence...</span>
<span class="output">BLOCKERS: None
SHOULD_FIX: Consider adding retry logic
SUGGESTIONS: Add docstring
VERDICT: <span class="success-text">APPROVE</span></span></pre>
                    </div>
                </div>

            </div>
        </div>

        <!-- The Contract -->
        <div class="highlight-box">
            <h3>The One Contract</h3>
            <div class="terminal" style="border: none; background: transparent; padding: 0;">
<pre style="color: #c9d1d9;">
┌─────────────────────────────────────────────────────────────┐
│ <span class="success-text">AUTHORITATIVE COMPLETION</span> (strict mode only)                 │
│                                                             │
│ A task is "complete" when <span class="warning-text">ALL</span> are true:                     │
│   1. DONE_REPORT present in transcript                      │
│   2. audit_done verifies claims (if auto_audit enabled)     │
│   3. check_invariants passes (if configured)                │
│                                                             │
│ In strict mode: DONE_REPORT is <span class="error-text">REQUIRED</span>.                    │
│ If missing, task is marked INCOMPLETE even if agent is      │
│ "ready". No DONE_REPORT = not done.                         │
│                                                             │
│ Everything else (prompt appearing, "I'm done" text,         │
│ tmux idle) is <span class="dim">NON-AUTHORITATIVE</span>.                            │
└─────────────────────────────────────────────────────────────┘
</pre>
            </div>
        </div>

        <!-- Status Output Reference -->
        <h2>Status Output Reference</h2>
        <div class="step">
            <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">status</span>

<span class="output">Agent 1 (CodeflowViz): <span class="success-text">ready</span> [DONE <span class="success-text">2m ago</span>]</span>
<span class="dim">                       ↑ DONE_REPORT detected, timestamp shown</span>

<span class="output">Agent 2 (Council): <span class="warning-text">working</span> [awaiting DONE_REPORT]</span>
<span class="dim">                   ↑ Task sent, waiting for completion signal</span>

<span class="output">Agent 3 (DeepResearch): <span class="success-text">ready</span> [DONE: N/A] Q:2</span>
<span class="dim">                        ↑ No transcript_path configured, 2 tasks queued</span>

<span class="output">Agent 4 (Sandbox): <span class="success-text">ready</span></span>
<span class="dim">                   ↑ Not in strict mode, no DONE tracking</span></pre>
            </div>
        </div>

        <!-- Commands Reference -->
        <h2>New Commands</h2>
        <div class="step">
            <div class="terminal">
<pre><span class="prompt">council&gt;</span> <span class="command">queue 1 "Add tests for edge cases"</span>
<span class="output">Queued task for Agent 1 (queue depth: 1)</span>

<span class="prompt">council&gt;</span> <span class="command">progress 1 mark</span>
<span class="output">Progress marked for Agent 1 (streak reset)</span>
<span class="dim">↑ Manual escape hatch for circuit breaker</span>

<span class="prompt">council&gt;</span> <span class="command">1: grep "error|warning" logs.txt</span>
<span class="output">Sending to Agent 1...</span>
<span class="dim">↑ Pipe preserved literally (not split into tasks)</span></pre>
            </div>
        </div>

        <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #30363d; color: #484f58; font-size: 0.85rem;">
            council-v3 Tier-3 Authoritative Completion System
        </div>
    </div>
</body>
</html>
